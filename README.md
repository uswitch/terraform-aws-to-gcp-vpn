# VPN Tunnels between AWS and GCP

This repository contains the infrastructure to create HA VPNs between an AWS VPC and a GCP project.

The infrastructure created was based on following this guide [here](https://cloud.google.com/community/tutorials/using-ha-vpn-with-aws)

Note: This will require using Terraform 0.12

## High-level configuration steps
Because HA VPN is dependent on BGP IP settings generated by AWS, you must configure Cloud VPN and AWS components in the following sequence:

1. Create the HA VPN gateway and create a Cloud Router.
2. Create one AWS virtual private gateway.
3. Create two AWS site-to-site VPN connections and two customer gateways.
4. Create four VPN tunnels on the HA VPN gateway.
5. Configure BGP sessions on the Cloud Router using the BGP IP addresses from AWS

## How To Use
This module assumes that you have an existing AWS VPC and and exisiting GCP Network you would like to connect. If you do not have these, you will need to create these before using the module.

Assuming you have existing infrastructure, enter the AWS ID of your VPC and the region where your VPC resides in as well as the GCP Network Name and GCP Region where the Network is located, in to the correct input fields similar to the example below.

The remaining variable to define is BGP_ASN. This can be `Any private ASN (64512-65534, 4200000000-4294967294) that you are not already using in the peer network. The ASN is used for all BGP sessions on the same Cloud Router, and it cannot be changed later.` AWS uses `65000` as the default, so we also `65000` as the default

```
module "aws-to-gcp-vpn" {
  source = "git@github.com:uswitch/terraform-aws-to-gcp-vpn.git"

  # AWS Variables
  aws_vpc_id = << AWS_VPC_ID >>
  aws_region = << AWS_VPC_REGION >>

  bgp_asn    = << BGP_ASN >>

  # GCP Variables
  gcp_network_name = << GCP_NETWORK_NAME >>
  gcp_region       = << GCP_REGION >>
}
```

This will spin up 2 VPNs and 4 tunnels between AWS and GCP.

To enable communication from the AWS side, you will need to create routes to the subnet where you would like to connect too.

For example;
```
resource "aws_route" "route_to_vpn_gateway" {
  route_table_id         = << ROUTE_TABLE_ID >>
  destination_cidr_block = << GOOGLE_SUBNET_CIDR_RANGE >>
  gateway_id             = << VPN_GATEWAY_ID >>
}
```
`ROUTE TABLE ID` is the ID of the Route Table associated to the subnet where your instance lives

`GOOGLE_SUBNET_CIDR_RANGE` is the cidr range of your subnets in your GCP network.

`VPN_GATEWAY_ID` is the ID of the VPN Gateway which can be accessed as an output from the module using something similar to `module.aws-to-gcp-vpn.aws_vpn_gateway_id`


## Example
The example directory contains an example of how to use the module and the variables to be passed to the module.

In the example, instances and security groups are created in AWS and GCP allowing you to SSH on to the respective instances and ping the other instance to confirm connectivity.

To get the example to run, add an `inputs.tfvars` file with the values for the variables in `variables.tf` and run `terraform plan --var-file=inputs.tfvars` and `terraform apply --var-file=inputs.tfvars`
